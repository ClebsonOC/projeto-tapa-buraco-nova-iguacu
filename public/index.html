<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tapa Buracos - Nova Iguaçu</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding:0; background-color: #f4f4f4; color: #333; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh;}
    .container { width: 100%; max-width: 750px; margin: 20px; background-color: #fff; padding: 20px 25px 30px 25px; border-radius: 8px; box-shadow: 0 0 12px rgba(0,0,0,0.1); }
    label { display: block; margin-top: 15px; margin-bottom: 8px; font-weight: bold; font-size:0.95em; }
    input[type="text"], input[type="file"], input[inputmode="decimal"] {
      width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;
      box-sizing: border-box; margin-bottom: 10px; font-size: 1rem;
    }
    #sugestoes { border: 1px solid #ddd; border-top:none; max-height: 200px; overflow-y:auto; margin-top: -11px; padding: 0; background-color: #fff; border-radius: 0 0 4px 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: relative; z-index: 1000; }
    .sugestao-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; font-size:0.95rem; }
    .sugestao-item:last-child { border-bottom: none; }
    .sugestao-item:hover, .sugestao-item.active { background-color: #e9e9e9; }
    .sugestao-item strong { font-weight: bold; color: #007bff;}
    h1, h2 { color: #333; text-align: center; }
    h1 { margin-bottom: 25px; font-size: 1.8em;}
    h2 { margin-top: 20px; margin-bottom:15px; font-size: 1.3em; border-top: 1px solid #eee; padding-top: 20px;}
    .buraco-entry { border: 1px solid #eee; padding: 15px; margin-top: 15px; border-radius: 6px; background-color: #f9f9f9; }
    .buraco-entry label { margin-top: 5px; font-weight:normal; font-size:0.9em; }
    .buraco-header { font-weight: bold; margin-bottom: 10px; font-size: 1.05em; color:#555; }
    button { background-color: #007bff; color: white; padding: 10px 18px; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; margin-top: 10px; margin-right: 10px; transition: background-color 0.2s ease;}
    button:hover:not(:disabled) { background-color: #0056b3; }
    button:disabled { background-color: #cccccc; cursor: not-allowed;}
    .remove-buraco-btn { background-color: #dc3545; font-size: 0.8em; padding: 6px 10px; margin-top:0px; }
    .remove-buraco-btn:hover { background-color: #c82333; }
    #addBuracoBtn { background-color: #17a2b8; }
    #addBuracoBtn:hover { background-color: #138496; }
    #salvarTudoBtn { background-color: #28a745; font-size: 1.1em; padding: 12px 22px; }
    #salvarTudoBtn:hover { background-color: #218838; }
    #statusSalvar { margin-top:15px; font-weight:bold; text-align: center; min-height: 20px; padding: 8px; border-radius: 4px;}
    #statusSalvar.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb;}
    #statusSalvar.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;}
    .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1); width: 24px; height: 24px;
        border-radius: 50%; border-left-color: #007bff;
        animation: spin 1s ease infinite; display: none; margin: 10px auto;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .tempo-container { margin-top: 10px; margin-bottom: 15px; padding:10px; border:1px solid #eee; border-radius:4px; background-color:#f9f9f9; }
    .tempo-container label { margin-right: 15px; font-weight: normal; display: inline-block; cursor:pointer; }
    .tempo-container input[type="radio"] { margin-right: 5px; vertical-align: middle; width: auto; cursor:pointer;}
    hr { border: none; border-top: 1px solid #eee; margin-top: 25px; margin-bottom: 20px;}
  </style>
</head>
<body>
  <div class="container">
    <h1>Tapa Buracos - Nova Iguaçu</h1>

    <label for="ruaInput">1. Digite e selecione o nome da rua:</label>
    <input type="text" id="ruaInput" name="ruaInput" autocomplete="off" placeholder="Ex: Rua Dom Adriano (mín. 2 letras)">
    <div id="sugestoes" style="display:none;"></div>

    <h2>2. Registre os Buracos para a Rua Selecionada:</h2>
    <div id="buracosContainer"></div>
    <button type="button" id="addBuracoBtn">Adicionar Novo Buraco</button>

    <h2>3. Condição do Tempo:</h2>
    <div class="tempo-container" id="tempoContainer">
      <input type="radio" id="tempoBom" name="condicaoTempo" value="Bom" checked>
      <label for="tempoBom">Bom</label>
      <input type="radio" id="tempoNublado" name="condicaoTempo" value="Nublado">
      <label for="tempoNublado">Nublado</label>
      <input type="radio" id="tempoChuva" name="condicaoTempo" value="Chuva">
      <label for="tempoChuva">Chuva</label>
    </div>

    <label for="fotoGeralInput">4. Adicionar Foto(s) Geral(is) (Opcional):</label>
    <input type="file" id="fotoGeralInput" name="fotoGeralInput" accept="image/*" multiple>

    <div style="text-align: center; margin-top: 30px;">
      <button type="button" id="salvarTudoBtn">Salvar Dados dos Buracos</button>
      <div class="spinner" id="loadingSpinner"></div>
    </div>
    <div id="statusSalvar"></div>
  </div>

  <script>
    const ruaInputElement = document.getElementById('ruaInput');
    const sugestoesDivElement = document.getElementById('sugestoes');
    const buracosContainerElement = document.getElementById('buracosContainer');
    const addBuracoBtnElement = document.getElementById('addBuracoBtn');
    const salvarTudoBtnElement = document.getElementById('salvarTudoBtn');
    const statusSalvarElement = document.getElementById('statusSalvar');
    const loadingSpinnerElement = document.getElementById('loadingSpinner');
    const fotoGeralInputElement = document.getElementById('fotoGeralInput');

    let debounceTimer;
    let nextUniqueBuracoId = 1;
    let ruasSugeridas = []; 

    // --- LÓGICA DE AUTENTICAÇÃO E INICIALIZAÇÃO ---
    document.addEventListener('DOMContentLoaded', function() {
        const loggedInUser = localStorage.getItem('loggedInUser');
        if (!loggedInUser) {
            window.location.href = '/login.html'; 
            return; 
        }
        
        console.log('Usuário logado:', loggedInUser);
        const containerDiv = document.querySelector('.container'); 
        if (containerDiv) {
            const userDisplay = document.createElement('div');
            userDisplay.style.textAlign = 'right';
            userDisplay.style.marginBottom = '15px'; 
            userDisplay.style.fontSize = '0.9em';
            userDisplay.innerHTML = `Logado como: <strong>${loggedInUser}</strong> <button id="logoutBtn" type="button" style="font-size:0.9em; padding:5px 8px; margin-left:10px; background-color:#6c757d; color:white; border:none; border-radius:4px; cursor:pointer;">Sair</button>`;
            
            if (containerDiv.firstChild) {
                containerDiv.insertBefore(userDisplay, containerDiv.firstChild);
            } else {
                containerDiv.appendChild(userDisplay);
            }

            document.getElementById('logoutBtn').addEventListener('click', function() {
                localStorage.removeItem('loggedInUser');
                window.location.href = '/login.html';
            });
        }
        
        adicionarNovoBuraco(); // Adiciona o primeiro buraco
        ruaInputElement.focus();
    });
    // --- FIM DA LÓGICA DE AUTENTICAÇÃO ---

    function removerAcentosClientSide(texto) {
      if (texto == null) return "";
      return texto.toString().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    }

    // --- Lógica de Autocomplete de Rua ---
    ruaInputElement.addEventListener('input', function(event) { 
      clearTimeout(debounceTimer);
      const textoDigitado = event.target.value;
      if (textoDigitado.length < 2) {
        sugestoesDivElement.innerHTML = '';
        sugestoesDivElement.style.display = 'none';
        return;
      }
      debounceTimer = setTimeout(() => {
        sugestoesDivElement.innerHTML = '<div class="sugestao-item">Buscando...</div>';
        sugestoesDivElement.style.display = 'block';
        
        fetch('/api/buscar-ruas?texto=' + encodeURIComponent(textoDigitado))
          .then(response => {
            if (!response.ok) { throw new Error('Erro na rede: ' + response.statusText); }
            return response.json();
          })
          .then(listaDeRuas => {
            exibirSugestoes(listaDeRuas, textoDigitado);
          })
          .catch(erro => {
            console.error('Erro ao buscar ruas:', erro);
            sugestoesDivElement.innerHTML = '<div class="sugestao-item">Erro ao buscar. Tente novamente.</div>';
            sugestoesDivElement.style.display = 'block';
          });
      }, 350);
    });

    function exibirSugestoes(ruas, textoDigitado) {
      sugestoesDivElement.innerHTML = '';
      ruasSugeridas = ruas; 
      if (ruas && ruas.length > 0) {
        sugestoesDivElement.style.display = 'block';
        ruas.forEach(function(rua, index) {
          const divItem = document.createElement('div');
          divItem.className = 'sugestao-item';
          divItem.setAttribute('data-index', index); 

          const textoBuscaLower = removerAcentosClientSide(textoDigitado.toLowerCase());
          const ruaOriginalLowerSemAcento = removerAcentosClientSide(rua.toLowerCase());
          const startIndex = ruaOriginalLowerSemAcento.indexOf(textoBuscaLower);
          
          if (startIndex > -1) {
            let highlightedHTML = "";
            let currentIndexSemAcento = 0;
            for (const charOriginal of rua) {
                const charOriginalSemAcento = removerAcentosClientSide(charOriginal.toLowerCase());
                if (currentIndexSemAcento >= startIndex && currentIndexSemAcento < startIndex + textoBuscaLower.length && textoBuscaLower.length > 0) {
                    highlightedHTML += '<strong>' + charOriginal + '</strong>';
                } else {
                    highlightedHTML += charOriginal;
                }
                if (charOriginalSemAcento.length > 0) { 
                    currentIndexSemAcento += charOriginalSemAcento.length;
                }
            }
            divItem.innerHTML = highlightedHTML;
          } else {
            divItem.textContent = rua;
          }
          
          divItem.addEventListener('click', function() {
            selecionarRua(rua);
          });
          sugestoesDivElement.appendChild(divItem);
        });
      } else {
        sugestoesDivElement.innerHTML = '<div class="sugestao-item">Nenhuma rua encontrada.</div>';
        sugestoesDivElement.style.display = 'block';
      }
    }
    
    function selecionarRua(rua) {
        ruaInputElement.value = rua;
        sugestoesDivElement.innerHTML = '';
        sugestoesDivElement.style.display = 'none';
        resetarFormularioParaNovaRua();
        document.getElementById('addBuracoBtn').focus(); 
    }

    document.addEventListener('click', function(event) {
      if (!ruaInputElement.contains(event.target) && !sugestoesDivElement.contains(event.target)) {
        sugestoesDivElement.innerHTML = '';
        sugestoesDivElement.style.display = 'none';
      }
    });
    // --- Fim da Lógica de Autocomplete ---

    function resetarFormularioParaNovaRua() {
      nextUniqueBuracoId = 1;
      buracosContainerElement.innerHTML = '';
      fotoGeralInputElement.value = ''; 
      document.getElementById('tempoBom').checked = true;
      adicionarNovoBuraco(); 
    }
    
    function limparFormularioAposSucesso() {
      ruaInputElement.value = '';
      sugestoesDivElement.innerHTML = '';
      sugestoesDivElement.style.display = 'none';
      nextUniqueBuracoId = 1;
      buracosContainerElement.innerHTML = '';
      fotoGeralInputElement.value = '';
      document.getElementById('tempoBom').checked = true;
      statusSalvarElement.textContent = '';
      statusSalvarElement.className = ''; 
      ruaInputElement.focus();
    }

    function renumerarBuracosVisualmente() {
      const buracoEntries = buracosContainerElement.getElementsByClassName('buraco-entry');
      for (let i = 0; i < buracoEntries.length; i++) {
        const header = buracoEntries[i].querySelector('.buraco-header');
        if (header) { header.textContent = `TAPA BURACO ${i + 1}`; }
      }
    }

    function adicionarNovoBuraco() {
      const buracoId = nextUniqueBuracoId++;
      const novoBuracoDiv = document.createElement('div');
      novoBuracoDiv.className = 'buraco-entry';
      novoBuracoDiv.id = 'buracoEntry_' + buracoId;
      novoBuracoDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div class="buraco-header">TAPA BURACO X</div>
          <button type="button" class="remove-buraco-btn" onclick="removerBuraco('${novoBuracoDiv.id}')">Remover</button>
        </div>
        <label for="largura_${buracoId}">Largura (m) (use vírgula):</label>
        <input type="text" inputmode="decimal" id="largura_${buracoId}" placeholder="Ex: 0,80">
        <label for="comprimento_${buracoId}">Comprimento (m) (use vírgula):</label>
        <input type="text" inputmode="decimal" id="comprimento_${buracoId}" placeholder="Ex: 1,20">
        <label for="espessura_${buracoId}">Espessura (cm) (use vírgula):</label>
        <input type="text" inputmode="decimal" id="espessura_${buracoId}" placeholder="Ex: 5,00">
      `;
      buracosContainerElement.appendChild(novoBuracoDiv);

      const camposNumericos = novoBuracoDiv.querySelectorAll('input[inputmode="decimal"]');
      camposNumericos.forEach(function(campo) {
        campo.addEventListener('input', manejarInputNumericoComVirgula);
        campo.addEventListener('blur', formatarAoSairComVirgula);
      });
      renumerarBuracosVisualmente();
      if (buracoId === 1 && !ruaInputElement.value) { // Foca na rua se for o primeiro buraco e a rua estiver vazia
          ruaInputElement.focus();
      } else {
          novoBuracoDiv.querySelector('input[inputmode="decimal"]').focus();
      }
    }
    
    window.removerBuraco = function(elementId) { 
      const buracoParaRemover = document.getElementById(elementId);
      if (buracoParaRemover) {
        buracoParaRemover.remove(); 
        renumerarBuracosVisualmente();
      }
    }
    addBuracoBtnElement.addEventListener('click', adicionarNovoBuraco);

    function manejarInputNumericoComVirgula(event) {
      let input = event.target;
      let valor = input.value;
      let cursorPos = input.selectionStart;
      
      valor = valor.replace(/\./g, ','); 
      
      let valorFiltrado = "";
      let virgulaEncontrada = false;
      let casasDecimais = 0;

      for (let i = 0; i < valor.length; i++) {
        const char = valor[i];
        if (char >= '0' && char <= '9') {
          if (virgulaEncontrada) {
            if (casasDecimais < 2) { valorFiltrado += char; casasDecimais++; }
          } else { valorFiltrado += char; }
        } else if (char === ',' && !virgulaEncontrada) {
          valorFiltrado += char; virgulaEncontrada = true;
        }
      }
      valor = valorFiltrado;
      if (input.value !== valor) {
        input.value = valor;
        if (cursorPos <= valor.length) {
           input.setSelectionRange(cursorPos, cursorPos);
        } else {
           input.setSelectionRange(valor.length, valor.length);
        }
      }
    }

    function formatarAoSairComVirgula(event) {
      let input = event.target;
      let valor = input.value.trim();
      if (valor === '') { input.value = ''; return; } 
      
      let valorParaFloat = valor.replace(',', '.'); 
      if (!isNaN(parseFloat(valorParaFloat)) && isFinite(valorParaFloat)) {
        let numero = parseFloat(valorParaFloat);
        input.value = numero.toFixed(2).replace('.', ','); 
      } else {
        input.value = ''; 
      }
    }
    // --- Fim da Lógica de Múltiplos Buracos ---

    // --- Lógica para Salvar Tudo ---
    salvarTudoBtnElement.addEventListener('click', function() {
      const ruaSelecionada = ruaInputElement.value.trim();
      if (!ruaSelecionada) {
        alert('Por favor, digite e selecione uma rua primeiro.');
        ruaInputElement.focus();
        return;
      }

      const condicaoTempoSelecionada = document.querySelector('input[name="condicaoTempo"]:checked');
      if (!condicaoTempoSelecionada) {
        alert('Por favor, selecione a condição do tempo.');
        return;
      }
      const valorCondicaoTempo = condicaoTempoSelecionada.value;

      const dadosDosBuracos = [];
      const entries = buracosContainerElement.getElementsByClassName('buraco-entry');
      if (entries.length === 0) {
        adicionarNovoBuraco(); 
        alert('Adicione as medidas para pelo menos um buraco antes de salvar.');
        return;
      }

      for (let i = 0; i < entries.length; i++) {
        const entry = entries[i];
        const idSuffix = entry.id.split('_')[1];
        const larguraInput = entry.querySelector('#largura_' + idSuffix);
        const comprimentoInput = entry.querySelector('#comprimento_' + idSuffix);
        const espessuraInput = entry.querySelector('#espessura_' + idSuffix);
        
        let larguraVal = larguraInput.value.trim(); 
        let comprimentoVal = comprimentoInput.value.trim();
        let espessuraVal = espessuraInput.value.trim();

        if (larguraVal === '' || comprimentoVal === '' || espessuraVal === '' ||
            isNaN(parseFloat(larguraVal.replace(',', '.'))) || 
            isNaN(parseFloat(comprimentoVal.replace(',', '.'))) || 
            isNaN(parseFloat(espessuraVal.replace(',', '.')))) {
          alert(`Por favor, preencha todas as medidas com números válidos para o TAPA BURACO ${i + 1}. Use vírgula para decimais.`);
          if (larguraVal === '' || isNaN(parseFloat(larguraVal.replace(',', '.')))) larguraInput.focus();
          else if (comprimentoVal === '' || isNaN(parseFloat(comprimentoVal.replace(',', '.')))) comprimentoInput.focus();
          else espessuraInput.focus();
          return;
        }
        dadosDosBuracos.push({
          identificador: `TAPA BURACO ${i + 1}`,
          largura: larguraVal, 
          comprimento: comprimentoVal, 
          espessura: espessuraVal    
        });
      }
      
      const loggedInUser = localStorage.getItem('loggedInUser');
      if (!loggedInUser) {
          alert("Sua sessão expirou ou você não está logado. Por favor, faça login novamente.");
          window.location.href = '/login.html';
          return;
      }

      statusSalvarElement.textContent = 'Preparando para enviar...';
      statusSalvarElement.className = '';
      loadingSpinnerElement.style.display = 'inline-block';
      salvarTudoBtnElement.disabled = true;

      const formData = new FormData();
      formData.append('dados', JSON.stringify({ 
          rua: ruaSelecionada, 
          buracos: dadosDosBuracos, 
          condicaoTempo: valorCondicaoTempo,
          username: loggedInUser
      }));

      const arquivosDeFoto = fotoGeralInputElement.files;
      if (arquivosDeFoto.length > 0) {
          for (let i = 0; i < arquivosDeFoto.length; i++) {
              formData.append('fotos', arquivosDeFoto[i]); 
          }
      }
      
      statusSalvarElement.textContent = 'Salvando dados no servidor...';

      fetch('/api/salvar', {
        method: 'POST',
        body: formData 
      })
      .then(response => {
        const statusCode = response.status;
        const statusText = response.statusText;
        return response.json().then(data => ({
            ok: response.ok, status: statusCode, statusText: statusText, body: data
        }));
      })
      .then(resObj => {
        loadingSpinnerElement.style.display = 'none';
        salvarTudoBtnElement.disabled = false;
        statusSalvarElement.textContent = resObj.body.message || resObj.body.error || 'Operação concluída.';
        
        if (resObj.ok && resObj.body.message) {
          statusSalvarElement.className = 'success';
          alert(resObj.body.message); 
          limparFormularioAposSucesso(); 
        } else {
          statusSalvarElement.className = 'error';
          console.error("Resposta do servidor não OK ou formato inesperado:", resObj);
        }
        setTimeout(() => { if (statusSalvarElement.textContent !== '') statusSalvarElement.textContent = ''; statusSalvarElement.className = ''; }, 7000);
      })
      .catch(erro => {
        console.error('Erro na requisição fetch para /api/salvar:', erro);
        statusSalvarElement.textContent = 'Erro crítico ao salvar: ' + erro.message + '. Verifique o console.';
        statusSalvarElement.className = 'error';
        loadingSpinnerElement.style.display = 'none';
        salvarTudoBtnElement.disabled = false;
        setTimeout(() => { if (statusSalvarElement.textContent.startsWith('Erro crítico ao salvar:')) statusSalvarElement.textContent = ''; statusSalvarElement.className = ''; }, 7000);
      });
    });
  </script>
</body>
</html>